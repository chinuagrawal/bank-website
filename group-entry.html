<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Group Entry Admin</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f0f0f0;
      padding: 40px;
    }

    .container {
      background: #fff;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
      max-width: 600px;
      margin: auto;
    }

    h2, h3 {
      text-align: center;
      color: #4a148c;
    }

    label {
      font-weight: bold;
      display: block;
      margin-top: 20px;
    }

    input[type="text"] {
      width: 100%;
      padding: 10px;
      margin-top: 5px;
      border: 1px solid #ccc;
      border-radius: 5px;
    }

    button {
      margin-top: 15px;
      background-color: #4a148c;
      color: white;
      padding: 10px 20px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }

    button:hover {
      background-color: #6a1b9a;
    }

    .kyc-list {
      margin-top: 10px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 30px;
    }

    th, td {
      padding: 8px 12px;
      border: 1px solid #ccc;
      text-align: left;
    }

    th {
      background-color: #f2f2f2;
    }

    .kyc-list div {
      background: #f8f8f8;
      padding: 5px 10px;
      margin: 3px 0;
      border-left: 4px solid #4a148c;
      border-radius: 3px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>Add Group & KYC</h2>
    <form id="group-form">
      <label>Group Name</label>
      <input type="text" id="groupName" required />

      <label>Group Code</label>
      <input type="text" id="groupCode" required />

      <label>Add KYC Codes (one at a time)</label>
      <input type="text" id="kycInput" placeholder="Enter KYC code" />
      

      <button type="submit">Submit Group</button>
    </form>

    <h3>Existing Groups</h3>
    <table id="groupTable">
      <thead>
        <tr><th>Group Name</th><th>Code</th><th>KYC Details</th></tr>

      </thead>
      <tbody></tbody>
    </table>
  <br>

  <h2>Add KYC to Existing Group</h2>
<form id="kyc-form">
  <label for="existingGroup">Select Group</label>
  <select id="existingGroup" required></select>

 <label>KYC Code</label>
<input type="text" id="kycCodeInput" placeholder="Enter KYC code" />

<label>User Name</label>
<input type="text" id="kycNameInput" placeholder="Enter User Name" />

<label>Aadhar Number</label>
<input type="text" id="kycAadharInput" placeholder="Enter Aadhar Number" />

<label>PAN Card</label>
<input type="text" id="kycPanInput" placeholder="Enter PAN Number" />

<button type="submit">Add KYC</button>
</form>
</div>

 <script>
  const kycs = [];

  function addKyc() {
    const kycCode = document.getElementById("kycCodeInput").value.trim();
    const userName = document.getElementById("kycNameInput").value.trim();
    const aadharNumber = document.getElementById("kycAadharInput").value.trim();
    const panCard = document.getElementById("kycPanInput").value.trim();

    if (!kycCode) {
      alert("KYC Code is required");
      return;
    }

    kycs.push({ kycCode, userName, aadharNumber, panCard });
    updateKycList();

    document.getElementById("kycCodeInput").value = '';
    document.getElementById("kycNameInput").value = '';
    document.getElementById("kycAadharInput").value = '';
    document.getElementById("kycPanInput").value = '';
  }

  function updateKycList() {
    document.getElementById("kycList").innerHTML = kycs.map(k => `
      <div>
        <strong>${k.kycCode}</strong> â€” ${k.userName} | Aadhar: ${k.aadharNumber}, PAN: ${k.panCard}
      </div>
    `).join('');
  }

  document.getElementById("group-form").addEventListener("submit", async function (e) {
    e.preventDefault();

    const groupName = document.getElementById("groupName").value.trim();
    const groupCode = document.getElementById("groupCode").value.trim();

    if (!groupName || !groupCode) {
      alert("Please fill in group name and code");
      return;
    }

    // Step 1: Create the group
    const groupRes = await fetch("http://localhost:3000/api/groups/group", {
      method: "POST",
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ groupName, groupCode })
    });

    if (!groupRes.ok) {
      const result = await groupRes.json();
      return alert(result.message || "Error adding group");
    }

    // Step 2: Add KYC entries
    for (let k of kycs) {
      await fetch("http://localhost:3000/api/groups/kyc", {
        method: "POST",
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          groupCode,
          kycCode: k.kycCode,
          userName: k.userName,
          aadharNumber: k.aadharNumber,
          panCard: k.panCard
        })
      });
    }

    alert("Group and KYC entries saved successfully");

    // Reset form
    kycs.length = 0;
    updateKycList();
    this.reset();
    loadGroups();
    loadGroupDropdown();
  });

  async function loadGroups() {
    const res = await fetch("http://localhost:3000/api/groups/group-names");
    const data = await res.json();
    const table = document.querySelector("#groupTable tbody");

    const rows = await Promise.all(data.map(async g => {
      const kycRes = await fetch(`http://localhost:3000/api/groups/kyc/${g.groupCode}`);
      const kycList = await kycRes.json();

      const kycsHTML = kycList.map(k => `
  <div>
    <strong>${k.kycCode}</strong> - ${k.userName || ''}<br/>
    Aadhar: ${k.aadharNumber || ''}, PAN: ${k.panCard || ''}
    <button onclick="editKYC('${k._id}', '${k.kycCode}', '${k.userName}', '${k.aadharNumber}', '${k.panCard}')">Edit</button>
  </div>
`).join('');


      return `
        <tr>
          <td>${g.groupName}</td>
          <td>${g.groupCode}</td>
          <td>${kycsHTML}</td>
        </tr>
      `;
    }));

    table.innerHTML = rows.join('');
  }

  async function loadGroupDropdown() {
    const res = await fetch("http://localhost:3000/api/groups/group-names");
    const data = await res.json();
    const dropdown = document.getElementById("existingGroup");

    dropdown.innerHTML = `<option value="">Select Group</option>` +
      data.map(g => `<option value="${g.groupCode}">${g.groupName} (${g.groupCode})</option>`).join('');
  }

  document.getElementById("kyc-form").addEventListener("submit", async function (e) {
  e.preventDefault();

  const groupCode = document.getElementById("existingGroup").value;
  const kycCode = document.getElementById("kycCodeInput").value.trim();
  const userName = document.getElementById("kycNameInput").value.trim();
  const aadharNumber = document.getElementById("kycAadharInput").value.trim();
  const panCard = document.getElementById("kycPanInput").value.trim();

  if (!groupCode || !kycCode) {
    alert("Group and KYC Code are required");
    return;
  }

  const res = await fetch("http://localhost:3000/api/groups/kyc", {
    method: "POST",
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ groupCode, kycCode, userName, aadharNumber, panCard })
  });

  const result = await res.json();
  if (res.ok) {
    alert("KYC added successfully");
    this.reset();
    loadGroups();
  } else {
    alert(result.message || "Failed to add KYC");
  }
});

function editKYC(id, code, name, aadhar, pan) {
  const newName = prompt("Enter new name:", name);
  const newAadhar = prompt("Enter new Aadhar number:", aadhar);
  const newPan = prompt("Enter new PAN card:", pan);

  if (!newName || !newAadhar || !newPan) return alert("All fields required");

  fetch(`http://localhost:3000/api/groups/kyc/${id}`, {
    method: "PUT",
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      userName: newName,
      aadharNumber: newAadhar,
      panCard: newPan
    })
  })
    .then(res => res.json())
    .then(result => {
      alert(result.message);
      loadGroups();
    })
    .catch(() => alert("Failed to update KYC"));
}


  // Initial load
  loadGroups();
  loadGroupDropdown();
</script>

</body>
</html>
